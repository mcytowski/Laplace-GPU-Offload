<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="last-modified" content="2020-04-28 23:16:43 +0800">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- meta "search-domain" used for google site search function google_search() -->
    <meta name="search-domain" value="">
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/lesson.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/syntax.css" />
    
    <link rel="shortcut icon" type="image/x-icon" href="/favicon-swc.ico" />
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
	<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->
    <title>Differences between OpenACC and OpenMP offloading models: Profiling</title>
  </head>
  <body>
    <div class="container">
      
<nav class="navbar navbar-default">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      
      

      
      <a class="navbar-brand" href="../index.html">Home</a>

    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">

	
        <li><a href="../conduct/">Code of Conduct</a></li>

        
	
        <li><a href="../setup.html">Setup</a></li>

        
        <li class="dropdown">
          <a href="../" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Episodes <span class="caret"></span></a>
          <ul class="dropdown-menu">
            
            <li><a href="../01-talks/index.html">Talks</a></li>
            
            <li><a href="../02-laplace-introduction/index.html">Introduction to Laplace Equation</a></li>
            
            <li><a href="../03-serial-implementation/index.html">Serial Implementation</a></li>
            
            <li><a href="../04-profiling/index.html">Profiling</a></li>
            
            <li><a href="../05-loop-parallelisation/index.html">Loop parallelisation</a></li>
            
            <li><a href="../06-data-management/index.html">Data management</a></li>
            
<!--	    <li role="separator" class="divider"></li>
            <li><a href="../aio.html">All in one page (Beta)</a></li>
-->
          </ul>
        </li>
	
<!--
	
	
        <li class="dropdown">
          <a href="../" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Extras <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="../reference.html">Reference</a></li>
            
            <li><a href="../about/index.html">About</a></li>
            
            <li><a href="../discuss/index.html">Discussion</a></li>
            
            <li><a href="../figures/index.html">Figures</a></li>
            
            <li><a href="../guide/index.html">Instructor Notes</a></li>
            
          </ul>
        </li>
	
-->

	
        <li><a href="../LICENSE.html">License</a></li>
<!--	
	<li><a href="/edit/gh-pages/_episodes/04-profiling.md">Improve this page <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></a></li>
	
--> 
      </ul>
      <form class="navbar-form navbar-right" role="search" id="search" onsubmit="google_search(); return false;">
        <div class="form-group">
          <input type="text" id="google-search" placeholder="Search..." aria-label="Google site search">
        </div>
      </form>
    </div>
  </div>
</nav>


<div class="row">
  <div class="col-xs-1">
    <h3 class="text-left">
      
      <a href="../03-serial-implementation/index.html"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span><span class="sr-only">previous episode</span></a>
      
    </h3>
  </div>
  <div class="col-xs-10">
    
    <h3 class="maintitle"><a href="../">Differences between OpenACC and OpenMP offloading models</a></h3>
    
  </div>
  <div class="col-xs-1">
    <h3 class="text-right">
      
      <a href="../05-loop-parallelisation/index.html"><span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span><span class="sr-only">next episode</span></a>
      
    </h3>
  </div>
</div>

<article>
<div class="row">
  <div class="col-md-1">
  </div>
  <div class="col-md-10">
    <h1 class="maintitle">Profiling</h1>
  </div>
  <div class="col-md-1">
  </div>
</div>


<blockquote class="objectives">
  <h2>Overview</h2>

  <div class="row">
    <div class="col-md-3">
      <strong>Teaching:</strong> 5 min
      <br/>
      <strong>Exercises:</strong> 10 min
    </div>
    <div class="col-md-9">
      <strong>Questions</strong>
      <ul>
	
	<li><p>Basic profiling to identify the most computationally expensive parts of the code</p>
</li>
	
      </ul>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3">
    </div>
    <div class="col-md-9">
      <strong>Objectives</strong>
      <ul>
	
	<li><p>Profile the code with the use of GNU gprof tool</p>
</li>
	
	<li><p>Identify the candidates for GPU optimisation</p>
</li>
	
      </ul>
    </div>
  </div>

</blockquote>

<h1 id="profiling">Profiling</h1>

<p>In this section we will use the GNU Gprof performance analysis tool to profile our Laplace code.</p>

<p>First, the code needs to be compiled with <em>-pg</em> and <em>-g</em> options. This will enable the generation of line-by-line profiling information for gprof.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash-4.2$ make -f makefile.gprof
gcc -pg -g -c -o laplace.o laplace.c
gcc -pg -g  -o laplace laplace.o
</code></pre></div></div>

<p>Next, we will execute the Laplace code as usual.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash-4.2$ srun -n 1 -u ./laplace 4000
Iteration  100, dt 0.457795
Iteration  200, dt 0.228820
Iteration  300, dt 0.152270
Iteration  400, dt 0.113999
Iteration  500, dt 0.091070
Iteration  600, dt 0.075823
Iteration  700, dt 0.064934
Iteration  800, dt 0.056746
Iteration  900, dt 0.050404
Iteration 1000, dt 0.045315
Iteration 1100, dt 0.041167
Iteration 1200, dt 0.037703
Iteration 1300, dt 0.034773
Iteration 1400, dt 0.032264
Iteration 1500, dt 0.030094
Iteration 1600, dt 0.028195
Iteration 1700, dt 0.026518
Iteration 1800, dt 0.025028
Iteration 1900, dt 0.023695
Iteration 2000, dt 0.022496
Iteration 2100, dt 0.021412
Iteration 2200, dt 0.020426
Total time was 84.610613 seconds.
</code></pre></div></div>
<p>After completing the task, the <em>gmon.out</em> file containing profiling information will be generated in the working directory.</p>

<p>Now, we can use the <em>gprof</em> profiler to generate the profiling report.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash-4.2<span class="nv">$ </span>gprof <span class="nt">-lbp</span> laplace gmon.out
</code></pre></div></div>
<p>The set of options used above (<em>-lbp</em>) will generate only line by line profiling information with no call graph analysis.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Flat profile:

Each sample counts as 0.01 seconds.
  %   cumulative   self              self     total
 time   seconds   seconds    calls  Ts/call  Ts/call  name
 23.77     15.27    15.27                             main (laplace.c:55 @ 40089e)
 18.85     27.38    12.11                             main (laplace.c:46 @ 4007a1)
 14.79     36.88     9.50                             main (laplace.c:56 @ 400949)
 13.84     45.76     8.89                             main (laplace.c:46 @ 400831)
 10.55     52.54     6.77                             main (laplace.c:47 @ 4007e7)
  8.21     57.81     5.28                             main (laplace.c:47 @ 40080c)
  5.22     61.16     3.35                             main (laplace.c:45 @ 40085b)
  2.78     62.95     1.79                             main (laplace.c:54 @ 400985)
  2.14     64.33     1.37                             main (laplace.c:54 @ 400892)
  0.16     64.43     0.10                             main (laplace.c:46 @ 400808)
  0.14     64.52     0.09                             main (laplace.c:45 @ 400795)
  0.03     64.54     0.02                             init (laplace.c:83 @ 400ab1)
  0.02     64.55     0.01                             main (laplace.c:44 @ 40086c)
  0.00     64.55     0.00        1     0.00     0.00  init (laplace.c:77 @ 400a92)
</code></pre></div></div>
<p>As can be seen, the majority of time is spent, as expected, in two parts of the code:</p>
<ul>
  <li>the main computational kernel
    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">GRIDX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
      <span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">GRIDY</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
          <span class="n">T_new</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">25</span> <span class="o">*</span> <span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span>
                                      <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>    
</code></pre></div>    </div>
  </li>
  <li>the loops computing the largest change in the temperature
    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">GRIDX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
  <span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">GRIDY</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">){</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">MAX</span><span class="p">(</span> <span class="n">fabs</span><span class="p">(</span><span class="n">T_new</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]),</span> <span class="n">dt</span><span class="p">);</span>
    <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_new</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>Those two loop nests are the candidates for directive-based GPU optimisation.</p>


<blockquote class="keypoints">
  <h2>Key Points</h2>
  <ul>
    
    <li><p>We have analysed the performance of the Laplace code with the use of GNU Gprof profiler</p>
</li>
    
    <li><p>We have identified the most computationally expensive parts of the code - two loop nests executed in each iteration of the solver</p>
</li>
    
  </ul>
</blockquote>

</article>

<div class="row">
  <div class="col-xs-1">
    <h3 class="text-left">
      
      <a href="../03-serial-implementation/index.html"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span><span class="sr-only">previous episode</span></a>
      
    </h3>
  </div>
  <div class="col-xs-10">
    
  </div>
  <div class="col-xs-1">
    <h3 class="text-right">
      
      <a href="../05-loop-parallelisation/index.html"><span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span><span class="sr-only">next episode</span></a>
      
    </h3>
  </div>
</div>


      
      	
<footer>
  <div class="row">
    <div class="col-md-6" align="left">
      <h4>
	Copyright &copy; 2016–2020
	<a href="http://pawsey.org.au">Pawsey Supercomputing Centre</a>

      </h4>
    </div>
    <div class="col-md-6" align="right">
      <h4>

	Adapted from <a href="http://software-carpentry.org">Software Carpentry</a>
	/
	<a href="mailto:mailto:help@pawsey.org.au">Contact</a>
      </h4>
    </div>
  </div>
</footer>

      
    </div>
    
<script src="../assets/js/jquery.min.js"></script>
<script src="../assets/js/bootstrap.min.js"></script>
<script src="../assets/js/lesson.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-37305346-2', 'auto');
  ga('send', 'pageview');
</script>

  </body>
</html>
